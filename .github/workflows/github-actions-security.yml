name: Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  zap-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write # Para SARIF
      issues: write # Para issues automáticas
      pull-requests: write # Para comentarios en PRs

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Dar permisos a scripts
        run: chmod +x ./scripts/*.sh

      - name: Security Health Check
        run: ./scripts/security_health_check.sh example.com

      - name: OWASP ZAP Baseline Scan
        id: zap
        uses: zaproxy/action-baseline@v0.13.0
        with:
          target: https://example.com
          artifact_name: zap-scan-results
          fail_action: false # Nunca falla por warnings
          allow_issue_writing: true # Crea issues si hay alertas nuevas
          cmd_options: >- # ← CORREGIDO: todo en una línea válida
            -J zap_report.json -r zap_report.html -w zap_report.md
            -z "-config baseline.threshold=Medium"
            -I                            # Ignora warnings para exit code

      - name: Subir reportes individuales
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: |
            zap_report.json
            zap_report.html
            zap_report.md

      # SARIF: Convertir JSON de ZAP a SARIF con jq (aparece en Security tab)
      - name: Generar y subir SARIF
        if: always()
        run: |
          # Instalar jq (rápido)
          sudo apt-get update -qq && sudo apt-get install -y jq

          # Crear SARIF básico solo con alertas Medium/High (riskcode >=2)
          jq -n \
            --argjson alerts '$(jq -c '[.site[]? | .alerts[]? | select(.riskcode >= 2) | { ruleId: .pluginId, message: { text: (.name // "Unknown") + ": " + (.description // ""), fullMessage: .solution // "" }, level: (if .riskcode == 3 then "error" else "warning" end), locations: [{ physicalLocation: { artifactLocation: { uri: (.url // "") } } }] } ]' zap_report.json || echo "[]")' \
            '{
              "$schema": "https://schemastore.azurewebsites.net/schemas/json/sarif/sarif-2.1.0-rtm.5.json",
              "version": "2.1.0",
              "runs": [{
                "tool": { "driver": { "name": "OWASP ZAP", "version": "stable" } },
                "results": $alerts
              }]
            }' > zap_report.sarif

          # Validar
          jq . zap_report.sarif || echo "SARIF generado (vacío si no hay alertas)"
        continue-on-error: true

      - name: Subir SARIF a GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v4 # ← v4: sin warning de deprecación
        if: always()
        with:
          sarif_file: zap_report.sarif
