name: Security Scan

# Super App Security Kit - Pipeline DevSecOps
# Incluye: Health Check + SAST (Semgrep) + DAST (OWASP ZAP) + GitHub Code Scanning

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  TARGET_URL: ${{ vars.TARGET_URL || 'https://example.com' }}

jobs:
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dar permisos a scripts
        run: chmod +x ./scripts/*.sh

      # ---------------------------
      # HEALTH CHECK
      # ---------------------------
      - name: Security Health Check
        run: ./scripts/security_health_check.sh $(echo "${{ env.TARGET_URL }}" | awk -F[/:] '{print $4}' || echo "example.com")

      # ---------------------------
      # SAST – SEMGREP
      # ---------------------------
      - name: Instalar Semgrep
        run: pipx install semgrep || echo "Semgrep ya instalado"

      - name: Ejecutar Semgrep SAST
        run: ./scripts/sast_scan.sh

      - name: Subir reporte Semgrep
        uses: actions/upload-artifact@v4
        with:
          name: sast-semgrep-report
          path: semgrep_report.json

      # ---------------------------
      # DAST – OWASP ZAP con SARIF nativo
      # ---------------------------
      - name: OWASP ZAP Baseline Scan
        run: |
          mkdir -p zap_wrk reports

          docker run --rm -u root \
            -v $(pwd)/zap_wrk:/zap/wrk/:rw \
            -t ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
            -t ${{ env.TARGET_URL }} \
            -J zap_report.json \
            -w zap_report.md \
            -r zap_report.html \
            -z "-config baseline.threshold=Medium" \
            -I || true

      - name: Generar SARIF válido desde ZAP (tu código original, solo con ruta corregida)
        if: always()
        run: |
          sudo apt-get update -qq && sudo apt-get install -y jq
          mkdir -p reports
          JSON_FILE="zap_wrk/zap_report.json"
          SARIF_FILE="reports/zap_scan.sarif"

          if [ ! -f "$JSON_FILE" ] || [ ! -s "$JSON_FILE" ]; then
            echo "Creando SARIF vacío"
            cat > "$SARIF_FILE" <<'EOF'
          {
            "$schema": "https://json.schemastore.org/sarif-2.1.0.json",
            "version": "2.1.0",
            "runs": [{ "tool": { "driver": { "name": "OWASP ZAP" }}, "results": [] }]
          }
          EOF
          else
            # Tu lógica hermosa de conversión (la dejé casi intacta)
            if jq -e '. | type == "array"' "$JSON_FILE" > /dev/null; then
              ALERTS='.[] |.alerts[]?'
            else
              ALERTS='.site[]?.alerts[]?'
            fi

            jq -c "$ALERTS | select(.riskcode | tonumber >= 2) | {
              ruleId: \"ZAP-\(.pluginid)\",
              level: (if (.riskcode | tonumber) == 3 then \"error\" else \"warning\" end),
              message: { text: .alert },
              locations: [{ physicalLocation: { artifactLocation: { uri: .instances[0].uri }, region: { startLine: 1 } } }]
            }" "$JSON_FILE" > /tmp/results.json || true

            if [ ! -s /tmp/results.json ]; then jq -n '{version:"2.1.0",$schema:"https://json.schemastore.org/sarif-2.1.0.json",runs:[{"tool":{"driver":{"name":"OWASP ZAP"}},"results":[]}]}' > "$SARIF_FILE"
            else jq -n --slurpfile r /tmp/results.json '{version:"2.1.0",$schema:"https://json.schemastore.org/sarif-2.1.0.json",runs:[{tool:{driver:{name:"OWASP ZAP"}},results:$r}]}' > "$SARIF_FILE"; fi
          fi

      - name: Subir resultados a GitHub Code Scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: reports/zap_scan.sarif

      # ---------------------------
      # GENERAR SARIF VÁLIDO DESDE ZAP
      # ---------------------------
      - name: Convertir ZAP JSON → SARIF (robusto)
        if: always()
        run: |
          sudo apt-get update -qq && sudo apt-get install -y jq

          mkdir -p reports
          JSON_FILE="zap_reports/zap_report.json"
          SARIF_FILE="reports/zap_scan.sarif"

          # Si no existe o está vacío → SARIF vacío válido
          if [ ! -f "$JSON_FILE" ] || [ ! -s "$JSON_FILE" ]; then
            echo "ZAP no generó JSON → creando SARIF vacío"
            cat > "$SARIF_FILE" <<'EOF'
          {
            "$schema": "https://json.schemastore.org/sarif-2.1.0.json",
            "version": "2.1.0",
            "runs": [
              {
                "tool": {
                  "driver": { "name": "OWASP ZAP Baseline", "version": "stable" }
                },
                "results": []
              }
            ]
          }
          EOF
            echo "SARIF vacío creado"
            exit 0
          fi

          # Detectar formato (nuevo ZAP devuelve array, viejo devuelve objeto con .site)
          if jq -e '. | type == "array"' "$JSON_FILE" > /dev/null; then
            ALERTS_QUERY='.[] | .alerts[]?'
          else
            ALERTS_QUERY='.site[]?.alerts[]?'
          fi

          # Generar resultados SARIF (solo riskcode ≥ 2 → Medium/High)
          jq -c "
            $ALERTS_QUERY
            | select(.riskcode != null and (.riskcode | tonumber) >= 2)
            | {
                ruleId: \"ZAP-\\(.pluginid // \"unknown\")\\",
                level: (if (.riskcode | tonumber) == 3 then \"error\" else \"warning\" end),
                message: { text: \"\\(.alert // \\\"Sin título\\\")\\nRisk: \\(.riskdesc // \\\"unknown\\\")\\n\\(.desc // \\\"\\\")\" },
                locations: [
                  {
                    physicalLocation: {
                      artifactLocation: { uri: (.instances[0].uri // \"https://example.com\") },
                      region: { startLine: 1 }
                    }
                  }
                ]
              }
          " "$JSON_FILE" > /tmp/zap_results.json

          # Si no hay alertas → SARIF vacío
          if [ ! -s /tmp/zap_results.json ]; then
            echo "No hay alertas Medium+ → SARIF vacío"
            jq -n '{
              "$schema": "https://json.schemastore.org/sarif-2.1.0.json",
              "version": "2.1.0",
              "runs": [{ "tool": { "driver": { "name": "OWASP ZAP Baseline" }}, "results": [] }]
            }' > "$SARIF_FILE"
          else
            jq -n --slurpfile results /tmp/zap_results.json '{
              "$schema": "https://json.schemastore.org/sarif-2.1.0.json",
              "version": "2.1.0",
              "runs": [{
                "tool": { "driver": { "name": "OWASP ZAP Baseline", "version": "stable" }},
                "results": $results
              }]
            }' > "$SARIF_FILE"
          fi

          echo "SARIF generado correctamente:"
          ls -lh "$SARIF_FILE"
          jq . "$SARIF_FILE" > /dev/null && echo "SARIF válido según schema" || echo "SARIF inválido!"

      # ---------------------------
      # SUBIR A CODE SCANNING
      # ---------------------------
      - name: Upload SARIF to GitHub Code Scanning
        if: always() && github.repository == github.event.pull_request.head.repo.full_name || github.event_name == 'push'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: reports/zap_scan.sarif
          category: zap-baseline
