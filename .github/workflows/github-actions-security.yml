name: Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Dar permisos a scripts
        run: chmod +x ./scripts/*.sh

      # ---------------------------
      # HEALTH CHECK (tu script)
      # ---------------------------
      - name: Security Health Check
        run: ./scripts/security_health_check.sh example.com

      # ---------------------------
      # SAST – SEMGREP
      # ---------------------------
      - name: Instalar Semgrep
        run: |
          pipx install semgrep || echo "Semgrep ya instalado"

      - name: SAST Scan
        run: ./scripts/sast_scan.sh

      - name: Subir reporte SAST
        uses: actions/upload-artifact@v4
        with:
          name: sast-report
          path: semgrep_report.json

      # ---------------------------
      # ZAP SCAN
      # ---------------------------
      - name: OWASP ZAP Baseline Scan
        id: zap
        uses: zaproxy/action-baseline@v0.13.0
        with:
          target: https://example.com
          artifact_name: zapresults
          fail_action: false
          allow_issue_writing: true
          cmd_options: >-
            -z "-config baseline.threshold=Medium"
            -I

      # ---------------------------
      # ORGANIZAR REPORTES ZAP
      # ---------------------------
      - name: Organizar reportes ZAP
        run: |
          mkdir -p zap_reports
          mkdir -p zapscan
          mkdir -p zapresults

          # Mover archivos generados por ZAP si existen
          [ -f report_html.html ] && mv report_html.html zap_reports/
          [ -f report_md.md ] && mv report_md.md zap_reports/
          [ -f report_json.json ] && mv report_json.json zap_reports/

      - name: Subir reportes ZAP
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: |
            zap_reports
            zapscan
            zapresults

      # ---------------------------
      # Generar SARIF desde ZAP
      # ---------------------------
      - name: Generar SARIF seguro
        if: always()
        run: |
          sudo apt-get update -qq && sudo apt-get install -y jq

          if [ ! -f zap_report.json ]; then
            echo "No se encontró zap_report.json, generando SARIF vacío."
            echo '{
              "$schema": "https://schemastore.azurewebsites.net/schemas/json/sarif/sarif-2.1.0-rtm.5.json",
              "version": "2.1.0",
              "runs": [{
                "tool": { "driver": { "name": "OWASP ZAP", "version": "stable" } },
                "results": []
              }]
            }' > zap_report.sarif
            exit 0
          fi

          alerts=$(jq -c '[.site[]? | .alerts[]? | select(.riskcode >= 2) | {
            ruleId: .pluginId,
            message: { text: (.name // "Unknown") },
            level: (if .riskcode == 3 then "error" else "warning" end),
            locations: [{ physicalLocation: { artifactLocation: { uri: (.url // "") } } }]
          }]' zap_report.json || echo "[]")

          jq -n --argjson alerts "$alerts" '{
            "$schema": "https://schemastore.azurewebsites.net/schemas/json/sarif/sarif-2.1.0-rtm.5.json",
            "version": "2.1.0",
            "runs": [{
              "tool": { "driver": { "name": "OWASP ZAP", "version": "stable" } },
              "results": $alerts
            }]
          }' > zap_report.sarif

      - name: Subir SARIF a GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: zap_report.sarif
