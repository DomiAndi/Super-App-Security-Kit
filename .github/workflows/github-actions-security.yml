name: Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Dar permisos a scripts
        run: chmod +x ./scripts/*.sh

      # ---------------------------
      # HEALTH CHECK
      # ---------------------------
      - name: Security Health Check
        run: ./scripts/security_health_check.sh example.com

      # ---------------------------
      # SAST – SEMGREP
      # ---------------------------
      - name: Instalar Semgrep
        run: pipx install semgrep || echo "Semgrep ya instalado"

      - name: SAST Scan
        run: ./scripts/sast_scan.sh

      - name: Subir reporte SAST
        uses: actions/upload-artifact@v4
        with:
          name: sast-report
          path: semgrep_report.json

      # ---------------------------
      # ZAP SCAN (DAST)
      # ---------------------------
      - name: OWASP ZAP Baseline Scan (Docker)
        run: |
          mkdir -p zap_wrk
          docker run --rm \
          --user root \
            -v $(pwd)/zap_wrk:/zap/wrk/:rw \
            -w /zap/wrk \
            -t ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
            -t https://example.com \
            -J zap_report.json \
            -w zap_report.md \
            -z "-config baseline.threshold=Medium" \
            -I || true

      - name: Organizar reportes ZAP
        run: |
          mkdir -p zap_reports
          if compgen -G "zap_wrk/zap_report.*" > /dev/null; then
            mv zap_wrk/zap_report.* zap_reports/
          else
            echo "ZAP no generó reportes"
            touch zap_reports/zap_report.md
            echo "[]" > zap_reports/zap_report.json
          fi
          [ -f zap_wrk/zap.log ] && cp zap_wrk/zap.log zap_reports/ || true

      - name: Subir reportes ZAP
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: zap_reports/

      # ---------------------------
      # GENERAR SARIF
      # ---------------------------
      - name: Generar SARIF desde ZAP
        if: always()
        run: |
          sudo apt-get update -qq && sudo apt-get install -y jq

          JSON_FILE="zap_reports/zap_report.json"
          SARIF_FILE="zap_report.sarif"

          # Si no hay JSON o está vacío → SARIF vacío
          if [ ! -f "$JSON_FILE" ] || [ ! -s "$JSON_FILE" ]; then
            echo "ZAP no generó resultados → SARIF vacío"
            cat > "$SARIF_FILE" <<'EOF'
          {
            "$schema": "https://json.schemastore.org/sarif-2.1.0.json",
            "version": "2.1.0",
            "runs": [{
              "tool": { "driver": { "name": "OWASP ZAP", "version": "stable" } },
              "results": []
            }]
          }
          EOF
          else
            # Detectar estructura del JSON (array o objeto)
            FIRST_CHAR=$(head -c 1 "$JSON_FILE")

            if [ "$FIRST_CHAR" = "[" ]; then
              # Nueva estructura (array de sites)
              jq -c '
                .[]?.alerts[]
                | select(.riskcode >= 2)
                | {
                    ruleId: (.pluginid | tostring),
                    level: (if .riskcode == 3 then "error" else "warning" end),
                    message: { text: .alert },
                    locations: [{
                      physicalLocation: {
                        artifactLocation: { uri: "web://" + (.name | gsub("\\s"; "_") | ascii_downcase) + ".md" },
                        region: { startLine: 1 }
                      }
                    }]
                  }
              ' "$JSON_FILE"
            else
              # Estructura antigua (.site)
              jq -c '
                .site[].alerts[]
                | select(.riskcode >= 2)
                | {
                    ruleId: (.pluginid | tostring),
                    level: (if .riskcode == 3 then "error" else "warning" end),
                    message: { text: .alert },
                    locations: [{
                      physicalLocation: {
                        artifactLocation: { uri: "web://" + (.name | gsub("\\s"; "_") | ascii_downcase) + ".md" },
                        region: { startLine: 1 }
                      }
                    }]
                  }
              ' "$JSON_FILE"
            fi > /tmp/zap_alerts.json

            # Construir SARIF con originalUriBaseIds para esquema "web://" (compatible con DAST)
            cat > "$SARIF_FILE" <<'EOF'
          {
            "$schema": "https://json.schemastore.org/sarif-2.1.0.json",
            "version": "2.1.0",
            "runs": [{
              "tool": { "driver": { "name": "OWASP ZAP", "version": "stable" } },
              "originalUriBaseIds": {
                "web": { "uri": "https://example.com/" }
              },
              "results": []
            }]
          }
          EOF

            # Añadir los resultados (ahora con URIs relativos que usan "web://")
            RESULTS=$(jq -s '.[0].runs[0].results = .[1] | .[0]' "$SARIF_FILE" /tmp/zap_alerts.json)

            echo "$RESULTS" > "$SARIF_FILE"

            COUNT=$(jq '.runs[0].results | length' "$SARIF_FILE")
            echo "SARIF DAST-compatible generado con $COUNT hallazgos (sin error de esquema URI)"
          fi

          # Verificación
          ls -la "$SARIF_FILE"
          echo "Primer resultado (si hay): $(jq '.[0].runs[0].results[0] // "Ninguno"' /tmp/zap_alerts.json 2>/dev/null || echo "Sin alerts")"

      # ---------------------------
      # SUBIR SARIF
      # ---------------------------
      - name: Subir SARIF a GitHub Code Scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: zap_report.sarif
